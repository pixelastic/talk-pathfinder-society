extends /_includes/_layouts/sov

block config
  - pageTitle = "Automating Side Projects"
  - pageDescription = "How to keep your sanity while while keeping your side projects up to date"
  - pageAuthor = "Tim Carry"
  - pageTwitter = "pixelastic"
  - pageUrl = "Your url"

block slides
  +slide.bg-green.text-7
    .fla.flcnw.flc.white.text-shadow.amaranth.bold
      .fln Automating side projects

  +slide
    +title Side project life cycle
    .fla.flcnw.flccv.text-4.pl-9.flspa
      .fln ğŸ’¡ You have an awesome idea
      .fln ğŸ‘·â€â™€ï¸ You build and deploy it
      .fln ğŸ¥°  Everybody is happy
      .fln.gray-5(data-step) âŒ› Time passes
      .fln(data-step) ğŸ‘©â€âš•ï¸ You go back to fix a typo
      .fln.bold.red(data-step) ğŸ”¥ Everything is broken
    .notes
      p Deps are out of sync
      p Forgot the codebase
      p Does not happen with work project
      ul.ml-2
        li.bullet Always on it
        li.bullet Codebase in mind
        li.bullet More stakes

  include /_includes/_slides/who-am-i.pug

  +slide.bg-green.text-7
    .fla.flcnw.flc.white.text-shadow.amaranth.bold
      .fln Real-life example


  +slide.bg-cover.bg-no-repeat(style="background-image:url(./assets/images/gm.png)")
    .absolute.top-0.right-0.bottom-0.left-0.bg-black.bg-opacity-75p
    .relative.fla.flcnw.flc
      .text-shadow.gray-2.amaranth.text-7
        .flcnw.flc
          .fln.flrnw
            .fln.mr-4 I play
            .fln
              img.h-13(src="./assets/images/dndlogo.png")
          .fln every Sunday
    .notes
      p As a GM, I need to tell a story for my players
      p I read published material for inspiration
  
  +slide
    .absolute.top-0.right-0.bottom-0.left-0.fla.flrw
      - var index = 0;
      while index < 50
        .fln.w-10p
          img(src=`./assets/images/covers/${index}.jpg`)
        - index++
    .absolute.top-0.right-0.bottom-0.left-0.bg-black.bg-opacity-75p
    .relative.white.flcnw.fla
      .fla.flrnw
        .fln.flcnw.flc.w-50p
          img(src="./assets/images/pathfinder-society.png")
          .text-3.text-shadow 320+ published adventures
        .fln.flcnw.flc.w-50p.p-3
          img.border-01.border-gray-6.rounded-1(src="./assets/images/pathfinderwiki.png")
          a.underline(href="https://pathfinderwiki.com") https://pathfinderwiki.com

  +slide.bg-cover.bg-no-repeat(style="background-image:url(./assets/images/society-search.png)")
    .fla.flcnw.flc
      a.amaranth.white.text-shadow.text-6.bg-black.bg-opacity-75p.px-2.rounded(href="https://gamemaster.pixelastic.com/society/") gamemaster.pixelastic.com/society

  +slide
    +title A Tale of Two Repos
    .fla.flrnw
      .fln.w-50p.p-1.flcnw.border-gray-5.border-001
        .fln.flrnw.mb-2.gray.debu
          .fln.fill-current.flcnw.flc.px-01
            include /_includes/octicon-repo.svg
          .fln.blue.px-01 pixelastic
          .fln.px-01 /
          .fln.blue.bold.px-01 society-data
        .fla.flcnw.flspa
          .fln
            img(src="./assets/images/society-data.png")
          .fln
            .codeblock.language-js.pl-1 // data.json
            .codeblock.language-json.text-1.overflow-hidden.px-1.pb-1
              | "stayOfExecution": {
              |   "title": "Stay of Execution",
              |   "authors": ["Alison McKenzie"],
              |   "backcover": "When a petty thief named Hadge gets a lucky break and makes off with a powerful divination focus of the Pathfinder Society's masked leadership, you and your fellow Pathfinders set out to the sparsely populated Taldor frontier to find him and recover the focus. When the local governor tosses Hadge into the brutal Porthmos Prison for a minor crime, your mission suddenly becomes a jail break. Will you free Hadge and uncover the location of the focus before the gangs of Porthmos tear him apart?",
              |   "locations": ["Taldor", "Sardis Township", "Porthmos Prison"],
              |   "price": 3.99,
              |   "rating": 2.3,
              |   â€¦}
      .fln.w-50p.p-1.flcnw.border-gray-5.border-001.border-l-0
        .fln.flrnw.mb-2.gray
          .fln.fill-current.flcnw.flc.px-1
            include /_includes/octicon-repo.svg
          .fln.blue.px-01 pixelastic
          .fln.px-01 /
          .fln.blue.bold.px-01 society-website
        .fla.flcnw.flspa
          .fln.flcnw.flc
            img.h-15(src="./assets/images/society-search.png")
          .fln
            .codeblock.language-js.pl-1 // package.json
            .codeblock.language-json.text-1.overflow-hidden.px-1.pb-1
              | "devDependencies": {
              |   â€¦
              |   "society-data": "0.3.24",
              |   â€¦
              | }

  +slide
    +title Manual automation
    .fla.flrnw
      .fln.w-50p.p-1.flcnw.border-gray-5.border-001
        .fln.flrnw.mb-2.gray
          .fln.fill-current.flcnw.flc.px-01
            include /_includes/octicon-repo.svg
          .fln.blue.px-01 pixelastic
          .fln.px-01 /
          .fln.blue.bold.px-01 society-data
        .fla.flcnw.flspa.text-3.gray-7
          .fln
            .fln.flcnw.flc
              code.code $ yarn run regenerate
            .fln.p-1 Recrawl #[span.underline.gray-8 pathfinderwiki.com]
          .fln
            .fln.flcnw.flc
              code.code $ yarn run release
            .fln.p-1 Release a new version to npm
      .fln.w-50p.p-1.flcnw.border-gray-5.border-001.border-l-0
        .fln.flrnw.mb-2.gray
          .fln.fill-current.flcnw.flc.px-1
            include /_includes/octicon-repo.svg
          .fln.blue.px-01 pixelastic
          .fln.px-01 /
          .fln.blue.bold.px-01 society-website
        .fla.flcnw.flspa.text-3.gray-7
          .fln
            .fln.flcnw.flc
              code.code.text-2
                p $ yarn remove #[span.blue-4.bold society-data]
                p $ yarn add --dev #[span.blue-4.bold society-data]
                p $ yarn run algolia
            .fln.p-1 Update the data in Algolia
          .fln
            .fln.flcnw.flc
              code.code $ git push
            .fln.p-1 Deploy the website

  +slide.bg-green.text-7
    .fla.flcnw.flc.white.text-shadow.amaranth.bold
      .fln Settings goals

  +slide
    +title What I want
    .fla.flcnw.text-5.flc
      .fln.flspa.flcnw.gray-7.h-80p
        .fln ğŸ“¦ Libraries up to date
        .fln ğŸ’” ...without breaking anything
        .fln ğŸ•– Weekly update of the data
        .fln ğŸ” Algolia data in sync

  +slide
    +title ğŸ“¦ Keeping libraries up to date
    .fla.flrnw
      .fln.w-50p.p-1.flcnw.flc
        a.fln.flcnw.flc(href="https://docs.renovatebot.com/install-github-app/" target="_blank")
          img.h-70p.p-4(src="./assets/images/renovate.png")
          .blue-7.bold.text-center.p-2.text-3 Renovate Bot
      .fla.flcnw.flspa
        .fln.h-50p.flcnw.bg-contain.bg-no-repeat.bg-left(style="background-image:url(./assets/images/renovate-pr.png)")
        .fln.h-40p.flcnw.bg-contain.bg-no-repeat.bg-center(style="background-image:url(./assets/images/renovate-diff.png)")
    .notes
      p Automatically merge patch and minor
      p Creates PR only for major

  +slide
    +title What I want
    .fla.flcnw.text-5.flc
      .fln.flspa.flcnw.gray-7.h-80p
        .fln.bold.green âœ” Libraries up to date
        .fln ğŸ’” ...without breaking anything
        .fln.opacity-50p ğŸ•– Weekly update of the data
        .fln.opacity-50p ğŸ” Algolia data in sync

  +slide
    +title â¤ï¸  No broken builds
    .fla.flrnw
      .fln.w-40p.flcnw.flc
        a.fln.flcnw.flc.w-80p(href="https://circleci.com/" target="_blank")
          img(src="./assets/images/circleci.png")
      .fla.flcnw.flccv
        .fln.flcnw.flspa.h-50p
          .fln.flcnw
            .fln.flrnw.flrcv
              .fln.green.pr-4 âœ”
              .fln.pr-2
                img.h-5.w-5(src="./assets/images/circleci-icon.png")
              .fln.bold.gray-8 ci/circleci: ci
              .fln.pl-1.gray-6 â€” Your tests passed on CircleCI!
            .fln.text-center Renovate will #[.inline.bold merge to master]
          .fln.flcnw
            .fln.flrnw.flrcv
              .fln.red.pr-4 âœ˜
              .fln.pr-2
                img.h-5.w-5(src="./assets/images/circleci-icon.png")
              .fln.bold.gray-8 ci/circleci: ci
              .fln.pl-1.gray-6 â€” Your tests failed on CircleCI
            .fln.text-center Renovate will #[.inline.bold create a Pull Request]

  +slide
    +title What I want
    .fla.flcnw.text-5.flc
      .fln.flspa.flcnw.gray-7.h-80p
        .fln.bold.green âœ” Libraries up to date
        .fln.bold.green âœ” ...without breaking anything
        .fln ğŸ•– Weekly update of the data
        .fln.opacity-50p ğŸ” Algolia data in sync

  +slide
    +title ğŸ•– Scheduled runs
    .fla.flrnw
      .fln.w-40p.flcnw
        .fla.codeblock.language-yml.text-1.overflow-hidden.p-3.pb-1
          | # .circleci/config.yml
          | workflows:
          |   weeklyUpdate:
          |     triggers:
          |       - schedule:
          |           cron: '0 9 * * 2'
          |     jobs:
          |       - weeklyUpdate
          |       
          | jobs:
          |   weeklyUpdate:
          |     steps:
          |       - run: 'yarn run weeklyUpdate'
      .fla.flcnw
        .fln.flcnw.flc
          code.code $ yarn run weeklyUpdate
        .fla.bg-no-repeat.bg-contain.bg-center(style="background-image:url(./assets/images/weeklyUpdate-pr.png)")
    .notes
      p Create an issue if error
      p Allow me to manually check before merging
      p Crawling is hard. Especially user-generated content
      p I don't trust my own script that much
      p Using Octokit for create Issue/PR

  +slide
    +title Releasing to NPM
    p When PR is accepted, it will release a new version to npm
    p This is getting more complex. I'll need several pieces

  +slide
    +title CircleCI to run the job
    p I can create a new job on CircleCI that runs yarn run release patch
    p Run can be triggered through the API

  +slide
    +title GitHub WebHooks
    p GitHub can ping a url when specific even occured
    p Like when a PR is merged
    p I could ping my CircleCI url when the PR is merged!

  +slide
    +title Not so easy
    p GitHub webhooks are very generic
    p All PRs, merged or closed
    p Need a proxy to filter out the useless events and only triger on the right on

  +slide
    +title Netlify Functions
    p Netlify allow host dynamic nodejs scripts
    p Basically AWS lambda but deployed from the same repo
    p Reads incoming payload, check if correct PR and ping CircleCI

  +slide
    +title Recap
    p Every week the wiki is crawled and a PR created
    p When I accept it, GitHub sends a ping to my proxy
    p Everything checks out, it pings CircleCI that releases a new version
    p Because new dep, Renovate will pick up on the website
    p Make a commit on master with update with the new data

  +slide
    +title Re-indexing
    p Want to catch the commit that updates the update
    p Once again, too broad, listens to all commits
    p Create a proxy, find the right commit and run yarn run algolia
    p Now everything is ran correctly

  +slide
    +title My usual routine
    p Tuesday morning coffee, I read the PR
    p I validate it and go to work
    p In the background it will do a release of the module, which will trigger a re-indexing of the data and deploy of the website
    p If I need to work on the project, a git pull gives me all the deps updated

  +slide
    +title Gotchas
    p It's a complex setup. Moving pieces.
    p Important to document (or make a talk about it)
    p Hard to debug. WebHooks ok, Netlify bad, CircleCI awesome.
    p Suggest Sentry?
